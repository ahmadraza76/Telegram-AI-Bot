# enhanced_handlers.py
# Developer: Mr AHMAD 
# Enhanced USTAAD-AI Premium Telegram bot handlers with omni-domain expertise

import logging
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from ai_service import AIService
from language_detector import LanguageDetector
from user_preferences import UserPreferences
from utils import Utils
from config import Config
from knowledge_domains import KnowledgeDomainClassifier

logger = logging.getLogger(__name__)

class EnhancedBotHandlers:
    def __init__(self):
        self.ai_service = AIService()
        self.language_detector = LanguageDetector()
        self.user_preferences = UserPreferences()
        self.utils = Utils()
        self.domain_classifier = KnowledgeDomainClassifier()
        self.broadcast_messages = {}
        self.user_sessions = {}  # Track user sessions and context
        
        logger.info("ЁЯОп Enhanced Bot handlers initialized with omni-domain expertise")
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Enhanced /start command with comprehensive introduction"""
        try:
            user_info = self.utils.get_user_info(update)
            
            # Initialize user session
            self.user_sessions[user_info['id']] = {
                'start_time': update.message.date,
                'query_count': 0,
                'domains_explored': set(),
                'knowledge_level': 'intermediate'
            }
            
            # Get user's preferred language or detect
            preferred_lang = self.user_preferences.get_user_language(user_info['id'])
            if not preferred_lang:
                preferred_lang = self.language_detector.detect_language(
                    update.message.text or user_info.get('language_code', 'hi')
                )
            
            # Simulate typing
            await self.utils.simulate_typing(update.effective_chat.id, context, duration=2)
            
            # Get enhanced welcome message
            welcome_data = self._get_enhanced_welcome_message(preferred_lang)
            
            # Create enhanced inline keyboard
            keyboard = [
                [
                    InlineKeyboardButton("ЁЯОУ Academic Help", callback_data="domain_academic"),
                    InlineKeyboardButton("ЁЯТ╗ Tech Support", callback_data="domain_technology")
                ],
                [
                    InlineKeyboardButton("ЁЯОи Creative Zone", callback_data="domain_creative"),
                    InlineKeyboardButton("ЁЯТ╝ Business Guide", callback_data="domain_business")
                ],
                [
                    InlineKeyboardButton("ЁЯТк Life Coach", callback_data="domain_life"),
                    InlineKeyboardButton("ЁЯМН Cultural Guide", callback_data="domain_culture")
                ],
                [
                    InlineKeyboardButton("ЁЯЖШ Help & Commands", callback_data="help"),
                    InlineKeyboardButton("тД╣я╕П About USTAAD-AI", callback_data="info")
                ],
                [
                    InlineKeyboardButton("ЁЯМР Language Settings", callback_data="language_settings"),
                    InlineKeyboardButton("ЁЯУК My Stats", callback_data="user_stats")
                ]
            ]
            
            # Add admin broadcast button
            if self.utils.is_admin(user_info['id']):
                keyboard.insert(-1, [InlineKeyboardButton("ЁЯУв Admin Broadcast", callback_data="admin_broadcast")])
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # Send enhanced welcome message
            await update.message.reply_text(
                welcome_data,
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
            
            # Log interaction
            self.utils.log_user_interaction(
                user_info['id'], 
                user_info['username'], 
                "/start", 
                len(welcome_data)
            )
            
        except Exception as e:
            logger.error(f"тЭМ Error in enhanced start_command: {e}")
            await update.message.reply_text("тЪая╕П Sorry, something went wrong. Please try again.")

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Enhanced message handler with domain classification and expertise"""
        try:
            user_info = self.utils.get_user_info(update)
            user_message = update.message.text
            
            logger.info(f"ЁЯУи Processing query from user {user_info['id']}: '{user_message[:100]}...'")
            
            # Update user session
            if user_info['id'] in self.user_sessions:
                self.user_sessions[user_info['id']]['query_count'] += 1
            
            # Get user's preferred language
            preferred_lang = self.user_preferences.get_user_language(user_info['id'])
            if not preferred_lang:
                detected_lang = self.language_detector.detect_language(user_message)
                self.user_preferences.set_user_language(user_info['id'], detected_lang)
                preferred_lang = detected_lang
            
            # Classify query into knowledge domain
            domain, confidence = self.domain_classifier.classify_query(user_message, preferred_lang)
            
            # Update user's explored domains
            if user_info['id'] in self.user_sessions:
                self.user_sessions[user_info['id']]['domains_explored'].add(domain)
            
            logger.info(f"ЁЯОп Classified query as '{domain}' with confidence {confidence:.2f}")
            
            # Process enhanced AI response
            await self.handle_enhanced_ai_response(
                update, context, user_message, user_info, preferred_lang, domain, confidence
            )
            
        except Exception as e:
            logger.error(f"тЭМ Error in enhanced handle_message: {e}")
            await self._send_error_response(update, user_info, preferred_lang)

    async def handle_enhanced_ai_response(self, update: Update, context: ContextTypes.DEFAULT_TYPE,
                                        user_message: str, user_info: dict, preferred_lang: str,
                                        domain: str, confidence: float):
        """Enhanced AI response with domain expertise"""
        try:
            # Show domain-specific typing indicator
            typing_duration = 4 if confidence > 0.5 else 3
            await self.utils.simulate_typing(update.effective_chat.id, context, duration=typing_duration)
            
            # Get enhanced AI response
            ai_response = await self.ai_service.get_ai_response(
                user_info['id'], 
                user_message, 
                preferred_lang
            )
            
            # Enhance response with domain-specific context
            if confidence > 0.3:
                ai_response = self.domain_classifier.enhance_response_with_domain_context(
                    ai_response, domain, preferred_lang
                )
            
            # Format response with enhanced emojis and structure
            formatted_response = self._format_enhanced_response(ai_response, domain, preferred_lang)
            
            # Split long messages intelligently
            message_chunks = self.utils.split_long_message(formatted_response)
            
            # Create enhanced keyboard with domain-specific options
            keyboard = self._create_enhanced_keyboard(domain, user_info['id'], preferred_lang)
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # Send response(s) with enhanced formatting
            for i, chunk in enumerate(message_chunks):
                if i > 0:
                    await self.utils.simulate_typing(update.effective_chat.id, context, duration=1)
                
                # Add enhanced menu buttons only to the last chunk
                current_markup = reply_markup if i == len(message_chunks) - 1 else None
                
                await update.message.reply_text(
                    chunk,
                    reply_markup=current_markup,
                    parse_mode='Markdown'
                )
            
            # Log enhanced interaction
            self.utils.log_user_interaction(
                user_info['id'],
                user_info['username'],
                f"[{domain}] {user_message}",
                len(ai_response)
            )
            
        except Exception as e:
            logger.error(f"тЭМ Enhanced AI response error: {e}")
            await self._send_error_response(update, user_info, preferred_lang)

    def _get_enhanced_welcome_message(self, language: str) -> str:
        """Get enhanced welcome message with comprehensive capabilities"""
        messages = {
            'hi': f"""ЁЯОп **{Config.BOT_NAME} {Config.VERSION} рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ!** ЁЯОп

ЁЯЪА **рдореИрдВ рдЖрдкрдХрд╛ Omni-Domain AI Mentor рд╣реВрдВ!**

{Config.GURU_EMOJI} **Academic Excellence**: UPSC, JEE, NEET рд╕реЗ PhD рддрдХ
{Config.TECH_EMOJI} **Technology Mastery**: Programming, AI/ML, Cybersecurity
{Config.CREATIVE_EMOJI} **Creative Powerhouse**: Writing, Shayari, Content Creation
{Config.CULTURE_EMOJI} **Cultural Guide**: 12+ рднрд╛рд░рддреАрдп рднрд╛рд╖рд╛рдУрдВ рдореЗрдВ expertise
ЁЯТ╝ **Business Mentor**: Startup рд╕реЗ Corporate strategy рддрдХ
ЁЯТк **Life Coach**: Career, Relationships, Personal Growth

ЁЯФе **ChatGPT-Level Intelligence + Indian Context**

ЁЯТм **рдХреБрдЫ рднреА рдкреВрдЫреЗрдВ - рдореИрдВ рд╣рд░ domain рдХрд╛ expert рд╣реВрдВ!**
ЁЯУЪ Academic problems рд╕реЗ рд▓реЗрдХрд░ life advice рддрдХ, рд╕рдм рдХреБрдЫ!

{Config.POWERED_BY} | Developer: {Config.DEVELOPER}""",
            
            'ur': f"""ЁЯОп **{Config.BOT_NAME} {Config.VERSION} ┘Е█М┌║ ╪о┘И╪┤ ╪в┘Е╪п█М╪п!** ЁЯОп

ЁЯЪА **┘Е█М┌║ ╪в┘╛ ┌й╪з Omni-Domain AI Mentor █Б┘И┌║!**

{Config.GURU_EMOJI} **Academic Excellence**: UPSC, JEE, NEET ╪│█Т PhD ╪к┌й
{Config.TECH_EMOJI} **Technology Mastery**: Programming, AI/ML, Cybersecurity
{Config.CREATIVE_EMOJI} **Creative Powerhouse**: Writing, ╪┤╪з╪╣╪▒█М, Content Creation
{Config.CULTURE_EMOJI} **Cultural Guide**: 12+ █Б┘Ж╪п┘И╪│╪к╪з┘Ж█М ╪▓╪и╪з┘Ж┘И┌║ ┘Е█М┌║ expertise
ЁЯТ╝ **Business Mentor**: Startup ╪│█Т Corporate strategy ╪к┌й
ЁЯТк **Life Coach**: Career, Relationships, Personal Growth

ЁЯФе **ChatGPT-Level Intelligence + Indian Context**

ЁЯТм **┌й┌Ж┌╛ ╪и┌╛█М ┘╛┘И┌Ж┌╛█М┌║ - ┘Е█М┌║ █Б╪▒ domain ┌й╪з expert █Б┘И┌║!**
ЁЯУЪ Academic problems ╪│█Т ┘Д█Т ┌й╪▒ life advice ╪к┌й╪М ╪│╪и ┌й┌Ж┌╛!

{Config.POWERED_BY} | Developer: {Config.DEVELOPER}""",
            
            'default': f"""ЁЯОп **Welcome to {Config.BOT_NAME} {Config.VERSION}!** ЁЯОп

ЁЯЪА **I'm your Omni-Domain AI Mentor!**

{Config.GURU_EMOJI} **Academic Excellence**: From UPSC, JEE, NEET to PhD level
{Config.TECH_EMOJI} **Technology Mastery**: Programming, AI/ML, Cybersecurity
{Config.CREATIVE_EMOJI} **Creative Powerhouse**: Writing, Poetry, Content Creation
{Config.CULTURE_EMOJI} **Cultural Guide**: Expertise in 12+ Indian languages
ЁЯТ╝ **Business Mentor**: From Startups to Corporate strategy
ЁЯТк **Life Coach**: Career, Relationships, Personal Growth

ЁЯФе **ChatGPT-Level Intelligence + Indian Context**

ЁЯТм **Ask me anything - I'm an expert in every domain!**
ЁЯУЪ From academic problems to life advice, everything!

{Config.POWERED_BY} | Developer: {Config.DEVELOPER}"""
        }
        return messages.get(language, messages['default'])

    def _format_enhanced_response(self, response: str, domain: str, language: str) -> str:
        """Format response with enhanced structure and emojis"""
        
        # Add domain-specific emoji if not already present
        domain_emojis = {
            "academic_stem": Config.GURU_EMOJI,
            "competitive_exams": "ЁЯУЪ",
            "technology": Config.TECH_EMOJI,
            "creative_arts": Config.CREATIVE_EMOJI,
            "business_finance": "ЁЯТ╝",
            "life_skills": "ЁЯТк",
            "cultural_social": Config.CULTURE_EMOJI,
            "current_affairs": "ЁЯУ░",
            "health_wellness": "ЁЯПе"
        }
        
        # Enhance formatting based on content
        if domain in domain_emojis and not response.startswith(domain_emojis[domain]):
            response = f"{domain_emojis[domain]} {response}"
        
        # Add motivational footer for learning-related queries
        learning_keywords = ['learn', 'study', 'understand', 'рд╕реАрдЦрдирд╛', 'рд╕рдордЭрдирд╛', '╪│█М┌й┌╛┘Ж╪з']
        if any(keyword in response.lower() for keyword in learning_keywords):
            if language == 'hi':
                response += f"\n\nЁЯМЯ **{Config.BOT_NAME} Motivation**: рд╕рдлрд▓рддрд╛ рдХрд╛ рд░рд╛рд╕реНрддрд╛ knowledge рд╕реЗ рд╣реЛрдХрд░ рдЬрд╛рддрд╛ рд╣реИ! ЁЯТк"
            elif language == 'ur':
                response += f"\n\nЁЯМЯ **{Config.BOT_NAME} Motivation**: ┌й╪з┘Е█М╪з╪и█М ┌й╪з ╪▒╪з╪│╪к█Б ╪╣┘Д┘Е ╪│█Т █Б┘И┌й╪▒ ╪м╪з╪к╪з █Б█Т! ЁЯТк"
            else:
                response += f"\n\nЁЯМЯ **{Config.BOT_NAME} Motivation**: The path to success goes through knowledge! ЁЯТк"
        
        return response

    def _create_enhanced_keyboard(self, domain: str, user_id: int, language: str) -> list:
        """Create enhanced keyboard with domain-specific options"""
        
        # Base keyboard
        keyboard = [
            [
                InlineKeyboardButton("ЁЯУЛ Main Menu", callback_data="main_menu"),
                InlineKeyboardButton("ЁЯФД New Topic", callback_data="new_topic")
            ]
        ]
        
        # Add domain-specific quick actions
        domain_actions = {
            "academic_stem": [
                InlineKeyboardButton("ЁЯУЪ More Examples", callback_data="more_examples"),
                InlineKeyboardButton("ЁЯзо Practice Problems", callback_data="practice_problems")
            ],
            "competitive_exams": [
                InlineKeyboardButton("ЁЯУЕ Study Plan", callback_data="study_plan"),
                InlineKeyboardButton("ЁЯОп Exam Tips", callback_data="exam_tips")
            ],
            "technology": [
                InlineKeyboardButton("ЁЯТ╗ Code Examples", callback_data="code_examples"),
                InlineKeyboardButton("ЁЯФЧ Resources", callback_data="tech_resources")
            ],
            "creative_arts": [
                InlineKeyboardButton("ЁЯОи Creative Exercise", callback_data="creative_exercise"),
                InlineKeyboardButton("тЬНя╕П Writing Tips", callback_data="writing_tips")
            ],
            "business_finance": [
                InlineKeyboardButton("ЁЯУК Case Study", callback_data="case_study"),
                InlineKeyboardButton("ЁЯТб Business Ideas", callback_data="business_ideas")
            ],
            "life_skills": [
                InlineKeyboardButton("ЁЯОп Action Plan", callback_data="action_plan"),
                InlineKeyboardButton("ЁЯТк Motivation", callback_data="motivation_boost")
            ]
        }
        
        if domain in domain_actions:
            keyboard.insert(0, domain_actions[domain])
        
        # Add language and stats options
        keyboard.append([
            InlineKeyboardButton("ЁЯМР Language", callback_data="language_settings"),
            InlineKeyboardButton("ЁЯУК My Progress", callback_data="user_stats")
        ])
        
        # Add admin broadcast button for admin users
        if self.utils.is_admin(user_id):
            keyboard.append([InlineKeyboardButton("ЁЯУв Admin Panel", callback_data="admin_broadcast")])
        
        return keyboard

    async def button_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Enhanced button callback handler with domain-specific actions"""
        try:
            query = update.callback_query
            await query.answer()
            
            user_info = self.utils.get_user_info(update)
            callback_data = query.data
            
            # Get user's preferred language
            preferred_lang = self.user_preferences.get_user_language(user_info['id']) or 'hi'
            
            # Handle domain-specific callbacks
            if callback_data.startswith("domain_"):
                await self._handle_domain_selection(query, callback_data, user_info, preferred_lang)
            
            elif callback_data == "user_stats":
                await self._show_user_stats(query, user_info, preferred_lang)
            
            elif callback_data == "new_topic":
                await self._handle_new_topic(query, user_info, preferred_lang)
            
            elif callback_data in ["more_examples", "practice_problems", "study_plan", "exam_tips",
                                 "code_examples", "tech_resources", "creative_exercise", "writing_tips",
                                 "case_study", "business_ideas", "action_plan", "motivation_boost"]:
                await self._handle_quick_actions(query, callback_data, user_info, preferred_lang)
            
            # Handle existing callbacks (main_menu, help, info, etc.)
            else:
                await self._handle_standard_callbacks(query, callback_data, user_info, preferred_lang)
                
        except Exception as e:
            logger.error(f"тЭМ Error in enhanced button_callback: {e}")
            await query.edit_message_text("тЪая╕П Sorry, something went wrong with that action.")

    async def _handle_domain_selection(self, query, callback_data: str, user_info: dict, language: str):
        """Handle domain selection callbacks"""
        domain = callback_data.replace("domain_", "")
        
        domain_info = {
            "academic": {
                "title": "ЁЯОУ Academic Excellence Zone",
                "description": "UPSC, JEE, NEET, School/College subjects, Research help",
                "examples": ["Solve calculus problems", "UPSC preparation strategy", "Physics concepts"]
            },
            "technology": {
                "title": "ЁЯТ╗ Technology Mastery Hub",
                "description": "Programming, AI/ML, Cybersecurity, Web development",
                "examples": ["Python coding help", "Machine learning concepts", "Web development guide"]
            },
            "creative": {
                "title": "ЁЯОи Creative Powerhouse",
                "description": "Writing, Poetry, Content creation, Storytelling",
                "examples": ["Write a shayari", "Content strategy", "Creative writing tips"]
            },
            "business": {
                "title": "ЁЯТ╝ Business Strategy Center",
                "description": "Startup guidance, Marketing, Finance, Management",
                "examples": ["Business plan help", "Marketing strategies", "Investment advice"]
            },
            "life": {
                "title": "ЁЯТк Life Coaching Zone",
                "description": "Career guidance, Relationships, Personal development",
                "examples": ["Career planning", "Interview preparation", "Goal setting"]
            },
            "culture": {
                "title": "ЁЯМН Cultural Wisdom Hub",
                "description": "Indian culture, Traditions, Languages, Philosophy",
                "examples": ["Festival significance", "Cultural traditions", "Philosophy concepts"]
            }
        }
        
        info = domain_info.get(domain, domain_info["academic"])
        
        message = f"""**{info['title']}**

ЁЯУЛ **What I can help with:**
{info['description']}

ЁЯТб **Example queries:**
тАв {info['examples'][0]}
тАв {info['examples'][1]}
тАв {info['examples'][2]}

ЁЯТм **Just type your question and I'll provide expert guidance!**"""
        
        keyboard = [
            [InlineKeyboardButton("ЁЯТм Ask Question", callback_data="new_topic")],
            [InlineKeyboardButton("ЁЯФЩ Back to Menu", callback_data="main_menu")]
        ]
        
        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )

    async def _show_user_stats(self, query, user_info: dict, language: str):
        """Show user statistics and progress"""
        user_id = user_info['id']
        session = self.user_sessions.get(user_id, {})
        ai_stats = self.ai_service.get_user_stats(user_id)
        
        stats_message = f"""ЁЯУК **Your USTAAD-AI Journey**

ЁЯСд **User**: {user_info['first_name']} (@{user_info['username']})

ЁЯУИ **Session Stats:**
тАв Queries Asked: {session.get('query_count', 0)}
тАв Domains Explored: {len(session.get('domains_explored', set()))}
тАв Knowledge Level: {ai_stats.get('knowledge_level', 'Intermediate')}

ЁЯОп **Domains You've Explored:**
{', '.join(session.get('domains_explored', {'General'})) or 'None yet'}

ЁЯТм **Total Conversations**: {ai_stats.get('conversation_count', 0)}

ЁЯМЯ **Your Learning Journey**: Keep exploring different domains to become a well-rounded learner!

{Config.POWERED_BY}"""
        
        keyboard = [
            [InlineKeyboardButton("ЁЯФД Reset Stats", callback_data="reset_stats")],
            [InlineKeyboardButton("ЁЯФЩ Back to Menu", callback_data="main_menu")]
        ]
        
        await query.edit_message_text(
            stats_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )

    async def _handle_quick_actions(self, query, action: str, user_info: dict, language: str):
        """Handle quick action buttons"""
        
        action_responses = {
            "more_examples": "ЁЯУЪ I'll provide more detailed examples in our next conversation. Just ask for specific examples!",
            "practice_problems": "ЁЯзо Ready to practice? Ask me for practice problems in any subject!",
            "study_plan": "ЁЯУЕ I can create a personalized study plan. Tell me your exam and timeline!",
            "exam_tips": "ЁЯОп Ask me for specific exam strategies and I'll share proven tips!",
            "code_examples": "ЁЯТ╗ Need code examples? Just specify the programming language and problem!",
            "tech_resources": "ЁЯФЧ Ask me for resources on any technology topic!",
            "creative_exercise": "ЁЯОи Ready for a creative challenge? Ask me for writing prompts or exercises!",
            "writing_tips": "тЬНя╕П I'll share writing tips based on your specific needs. Just ask!",
            "case_study": "ЁЯУК Want a business case study? Tell me the industry or topic!",
            "business_ideas": "ЁЯТб Looking for business ideas? Share your interests and I'll suggest opportunities!",
            "action_plan": "ЁЯОп I'll help create an action plan. Tell me your goal!",
            "motivation_boost": "ЁЯТк Need motivation? Ask me for inspirational guidance!"
        }
        
        response = action_responses.get(action, "ЁЯТм Just ask me anything and I'll help!")
        
        keyboard = [
            [InlineKeyboardButton("ЁЯТм Ask Now", callback_data="new_topic")],
            [InlineKeyboardButton("ЁЯФЩ Back to Menu", callback_data="main_menu")]
        ]
        
        await query.edit_message_text(
            response,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )

    async def _handle_new_topic(self, query, user_info: dict, language: str):
        """Handle new topic selection"""
        message = f"""ЁЯТм **Ready for a New Question!**

ЁЯОп **I'm your expert in ALL domains:**
тАв ЁЯУЪ Academic & Competitive Exams
тАв ЁЯТ╗ Technology & Programming  
тАв ЁЯОи Creative Arts & Writing
тАв ЁЯТ╝ Business & Finance
тАв ЁЯТк Life Skills & Career
тАв ЁЯМН Culture & Current Affairs

**Just type your question and I'll provide expert guidance!**

{Config.TAGLINE}"""
        
        keyboard = [
            [InlineKeyboardButton("ЁЯФЩ Back to Menu", callback_data="main_menu")]
        ]
        
        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )

    async def _handle_standard_callbacks(self, query, callback_data: str, user_info: dict, language: str):
        """Handle standard callback queries (existing functionality)"""
        # This would include all the existing callback handling logic
        # from the original handlers.py file
        pass

    async def _send_error_response(self, update: Update, user_info: dict, language: str):
        """Send enhanced error response"""
        error_messages = {
            'hi': f"""ЁЯЩП рдорд╛рдлрд╝ рдХрд░реЗрдВ, рдореБрдЭреЗ рдХреБрдЫ technical difficulty рд╣реЛ рд░рд╣реА рд╣реИред

ЁЯФз **рд╕рдорд╛рдзрд╛рди:**
тАв рдХреБрдЫ seconds wait рдХрд░реЗрдВ рдФрд░ рдлрд┐рд░ try рдХрд░реЗрдВ
тАв рдЕрдЧрд░ problem persist рдХрд░реЗ рддреЛ @Mrnick66 рдХреЛ contact рдХрд░реЗрдВ

ЁЯТб **Meanwhile**: рдореИрдВ рдЬрд▓реНрджреА рд╣реА рдЖрдкрдХреА service рдореЗрдВ рд╡рд╛рдкрд╕ рдЖрдКрдВрдЧрд╛!

{Config.POWERED_BY} | Always Learning, Always Improving""",
            
            'default': f"""ЁЯЩП Sorry, I'm experiencing some technical difficulties.

ЁЯФз **Solutions:**
тАв Wait a few seconds and try again
тАв If problem persists, contact @Mrnick66

ЁЯТб **Meanwhile**: I'll be back to serve you shortly!

{Config.POWERED_BY} | Always Learning, Always Improving"""
        }
        
        error_msg = error_messages.get(language, error_messages['default'])
        
        keyboard = [
            [InlineKeyboardButton("ЁЯФД Try Again", callback_data="new_topic")],
            [InlineKeyboardButton("ЁЯУЛ Main Menu", callback_data="main_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(error_msg, reply_markup=reply_markup, parse_mode='Markdown')